# Test suite for get_aria_snapshot include_hidden parameter
#
# Usage:
#   1. Start HTTP server: cd examples && python -m http.server 8888
#   2. Navigate: navigate("http://localhost:8888/include-hidden-test.html")
#   3. Run tests: get_aria_snapshot(selector, include_hidden=...)
#   4. Verify output matches expected includes/excludes

metadata:
  description: Test suite for get_aria_snapshot include_hidden parameter
  version: "2.0"
  fixture: examples/include-hidden-test.html
  fixture_url: http://localhost:8888/include-hidden-test.html
  created: "2026-01-05"
  updated: "2026-01-06"
  notes: |
    Phase 2 changes:
    - Markers now granular: [hidden:display-none], [hidden:visibility-hidden], etc.
    - opacity:0 is now [visually-hidden:opacity] and INCLUDED by default (in AT)
    - Single marker returned (first match), not array
    - Ancestor propagation: children of hidden elements get [hidden:ancestor]

# =============================================================================
# Marker Categories (Phase 2)
# =============================================================================
#
# [hidden:X] - Element NOT in accessibility tree:
#   - aria-hidden    (aria-hidden="true")
#   - inert          (inert attribute)
#   - display-none   (display:none)
#   - visibility-hidden (visibility:hidden)
#   - visibility-collapse (visibility:collapse)
#   - ancestor       (parent is not in AT)
#
# [visually-hidden:X] - Element IN accessibility tree but not visible:
#   - opacity        (opacity:0)
#   - clipped        (clip/clip-path sr-only patterns)
#   - offscreen      (position:absolute with large negative offsets)
#
# Key semantic difference:
#   include_hidden=false: EXCLUDES [hidden:*], INCLUDES [visually-hidden:*]
#   include_hidden=true:  INCLUDES both with markers

# =============================================================================
# Test 1: aria-hidden="true"
# =============================================================================
test_1_aria_hidden:
  description: Elements with aria-hidden="true" attribute
  selector: "#test-1-aria-hidden .actual"
  tests:
    - id: "1.1"
      name: aria_hidden_excluded_by_default
      include_hidden: false
      expect:
        includes:
          - 'button "Visible Button"'
        excludes:
          - "ARIA Hidden Button"
          - "[hidden:"

    - id: "1.2"
      name: aria_hidden_included_with_marker
      include_hidden: true
      expect:
        includes:
          - 'button "Visible Button"'
          - "ARIA Hidden Button"
          - "[hidden:aria-hidden]"

# =============================================================================
# Test 2: inert attribute
# =============================================================================
test_2_inert:
  description: Elements with inert attribute
  selector: "#test-2-inert .actual"
  tests:
    - id: "2.1"
      name: inert_excluded_by_default
      include_hidden: false
      expect:
        includes:
          - 'button "Active Button"'
        excludes:
          - "Inert Button"
          - "Inert Link"
          - "[hidden:"

    - id: "2.2"
      name: inert_included_with_marker
      include_hidden: true
      expect:
        includes:
          - 'button "Active Button"'
          - "Inert Button"
          - "[hidden:inert]"

# =============================================================================
# Test 3: display:none
# =============================================================================
test_3_display_none:
  description: Elements with CSS display:none
  selector: "#test-3-display-none .actual"
  tests:
    - id: "3.1"
      name: display_none_excluded_by_default
      include_hidden: false
      expect:
        includes:
          - 'button "Displayed Button"'
        excludes:
          - "Display None Button"
          - "[hidden:"

    - id: "3.2"
      name: display_none_included_with_marker
      include_hidden: true
      expect:
        includes:
          - 'button "Displayed Button"'
          - "Display None Button"
          - "[hidden:display-none]"

# =============================================================================
# Test 4: visibility:hidden
# =============================================================================
test_4_visibility_hidden:
  description: Elements with CSS visibility:hidden
  selector: "#test-4-visibility-hidden .actual"
  tests:
    - id: "4.1"
      name: visibility_hidden_excluded_by_default
      include_hidden: false
      expect:
        includes:
          - 'button "Visible Button"'
        excludes:
          - "Visibility Hidden Button"
          - "[hidden:"

    - id: "4.2"
      name: visibility_hidden_included_with_marker
      include_hidden: true
      expect:
        includes:
          - 'button "Visible Button"'
          - "Visibility Hidden Button"
          - "[hidden:visibility-hidden]"

# =============================================================================
# Test 5: opacity:0 (NOW IN ACCESSIBILITY TREE)
# =============================================================================
test_5_opacity_zero:
  description: |
    Elements with opacity:0 ARE in the accessibility tree per W3C specs.
    This is how screen-reader-only patterns work (e.g., Amazon's .a-offscreen prices).
    Phase 2 change: Now [visually-hidden:opacity] and INCLUDED by default.
  selector: "#test-5-opacity-zero .actual"
  tests:
    - id: "5.1"
      name: opacity_zero_INCLUDED_by_default
      include_hidden: false
      expect:
        includes:
          - 'button "Opaque Button"'
          - "Transparent Button"
          - "[visually-hidden:opacity]"
        excludes:
          - "[hidden:"  # NOT hidden - it's visually-hidden

    - id: "5.2"
      name: opacity_zero_included_with_marker
      include_hidden: true
      expect:
        includes:
          - 'button "Opaque Button"'
          - "Transparent Button"
          - "[visually-hidden:opacity]"

# =============================================================================
# Test 6: Combined hiding (aria-hidden + CSS)
# =============================================================================
test_6_combined:
  description: |
    Element hidden by both aria-hidden="true" AND display:none.
    Phase 2: Returns first matching marker only (aria-hidden checked first).
  selector: "#test-6-combined .actual"
  tests:
    - id: "6.1"
      name: combined_excluded_by_default
      include_hidden: false
      expect:
        includes:
          - 'button "Visible Button"'
        excludes:
          - "Double Hidden Button"
          - "[hidden:"

    - id: "6.2"
      name: combined_shows_first_marker
      include_hidden: true
      expect:
        includes:
          - 'button "Visible Button"'
          - "Double Hidden Button"
          - "[hidden:aria-hidden]"  # First match wins

# =============================================================================
# Test 7: Screen-reader-only (sr-only pattern)
# =============================================================================
test_7_sr_only:
  description: |
    sr-only pattern (clip/offscreen) is IN accessibility tree but visually hidden.
    Phase 2: Gets [visually-hidden:clipped] marker but IS included by default.
  selector: "#test-7-sr-only .actual"
  tests:
    - id: "7.1"
      name: sr_only_INCLUDED_with_marker
      include_hidden: false
      expect:
        includes:
          - "Screen Reader Only Text"
          - "[visually-hidden:clipped]"  # New Phase 2 marker
        excludes:
          - "[hidden:"  # NOT hidden - it's visually-hidden

    - id: "7.2"
      name: sr_only_shows_all_markers
      include_hidden: true
      expect:
        includes:
          - "Screen Reader Only Text"
          - "[visually-hidden:clipped]"  # sr-only span
          - "[hidden:aria-hidden]"        # Icon Placeholder span

# =============================================================================
# Test 8: Nested hiding (ancestor propagation)
# =============================================================================
test_8_nested:
  description: |
    Parent has aria-hidden, child has display:none.
    Phase 2: Children of hidden parents get [hidden:ancestor] marker.
  selector: "#test-8-nested .actual"
  tests:
    - id: "8.1"
      name: nested_excluded_by_default
      include_hidden: false
      expect:
        includes:
          - 'button "Outer Visible Button"'
        excludes:
          - "Parent Hidden Button"
          - "Nested CSS Hidden Button"
          - "[hidden:"

    - id: "8.2"
      name: nested_shows_ancestor_marker
      include_hidden: true
      expect:
        includes:
          - 'button "Outer Visible Button"'
          - "Parent Hidden Button"
          - "Nested CSS Hidden Button"
          - "[hidden:aria-hidden]"  # On parent div
          - "[hidden:ancestor]"     # On children (inherited hidden state)

# =============================================================================
# Test 9: HTML5 hidden attribute
# =============================================================================
test_9_html_hidden:
  description: HTML5 hidden attribute (applies display:none)
  selector: "#test-9-html-hidden .actual"
  tests:
    - id: "9.1"
      name: html_hidden_excluded_by_default
      include_hidden: false
      expect:
        includes:
          - 'button "Visible Button"'
        excludes:
          - "HTML Hidden Button"
          - "[hidden:"

    - id: "9.2"
      name: html_hidden_included_with_display_none_marker
      include_hidden: true
      expect:
        includes:
          - 'button "Visible Button"'
          - "HTML Hidden Button"
          - "[hidden:display-none]"  # Browser applies display:none

# =============================================================================
# Test 10: Compact tree interaction
# =============================================================================
test_10_compact_interaction:
  description: Hidden containers preserved during tree compaction
  selector: "#test-10-compact .actual"
  tests:
    - id: "10.1"
      name: compact_preserves_hidden_container
      include_hidden: true
      compact_tree: true
      expect:
        includes:
          - "[hidden:aria-hidden]"
          - "Deeply Nested Hidden"
        # The parent generic with [hidden:aria-hidden] should NOT be collapsed

    - id: "10.2"
      name: compact_without_hidden_excludes
      include_hidden: false
      compact_tree: true
      expect:
        excludes:
          - "Deeply Nested Hidden"
          - "[hidden:"

# =============================================================================
# Test 11: aria-labelledby referencing hidden element
# =============================================================================
test_11_aria_labelledby:
  description: aria-labelledby correctly accesses hidden elements
  selector: "#test-11-labelledby .actual"
  tests:
    - id: "11.1"
      name: labelledby_gets_hidden_label_text
      include_hidden: false
      expect:
        includes:
          # Button should have name from hidden span (W3C spec requirement)
          - 'button "Hidden Label Text"'
        excludes:
          # The hidden span itself should not appear
          - "[hidden:"

    - id: "11.2"
      name: labelledby_hidden_shows_with_marker
      include_hidden: true
      expect:
        includes:
          - 'button "Hidden Label Text"'
          - "[hidden:aria-hidden]"

# =============================================================================
# Test 12: visibility:collapse (NEW Phase 2)
# =============================================================================
test_12_visibility_collapse:
  description: |
    visibility:collapse removes from accessibility tree.
    Behaves like hidden for most elements, like display:none for table elements.
  selector: "#test-12-visibility-collapse .actual"
  tests:
    - id: "12.1"
      name: visibility_collapse_excluded_by_default
      include_hidden: false
      expect:
        includes:
          - 'button "Visible Button"'
        excludes:
          - "Collapsed Button"
          - "[hidden:"

    - id: "12.2"
      name: visibility_collapse_included_with_marker
      include_hidden: true
      expect:
        includes:
          - 'button "Visible Button"'
          - "Collapsed Button"
          - "[hidden:visibility-collapse]"

# =============================================================================
# Test 13: Offscreen positioning (NEW Phase 2)
# =============================================================================
test_13_offscreen:
  description: |
    Elements positioned far off-screen (left:-9999px etc.) are IN accessibility tree
    but visually hidden. Gets [visually-hidden:offscreen] marker.
  selector: "#test-13-offscreen .actual"
  tests:
    - id: "13.1"
      name: offscreen_INCLUDED_by_default
      include_hidden: false
      expect:
        includes:
          - 'button "Visible Button"'
          - "Offscreen Button"
          - "[visually-hidden:offscreen]"
        excludes:
          - "[hidden:"

    - id: "13.2"
      name: offscreen_included_with_marker
      include_hidden: true
      expect:
        includes:
          - 'button "Visible Button"'
          - "Offscreen Button"
          - "[visually-hidden:offscreen]"

# =============================================================================
# Test 14: visibility:visible overrides inherited visibility:hidden
# =============================================================================
test_14_visibility_override:
  description: |
    Per CSS spec, a child with visibility:visible IS visible even when parent
    has visibility:hidden. This only applies to visibility inheritance, not
    to display:none, aria-hidden, or inert. The override button should appear
    in the accessibility tree without any hidden marker.
  selector: "#test-14-visibility-override .actual"
  tests:
    - id: "14.1"
      name: visibility_override_visible_in_default
      include_hidden: false
      expect:
        includes:
          - "Override Visible Button"  # This child IS visible
        excludes:
          - "Still Hidden Button"  # This sibling inherits parent's visibility:hidden

    - id: "14.2"
      name: visibility_override_shows_sibling_hidden
      include_hidden: true
      expect:
        includes:
          - "Override Visible Button"  # Visible child - no hidden marker
          - "Still Hidden Button"
          - "[hidden:ancestor]"  # Sibling inherits hidden from parent
        excludes:
          # Override button should NOT have a hidden marker
          - 'button "Override Visible Button" [hidden:'

# =============================================================================
# Summary
# =============================================================================
# Total: 14 test groups, 28 individual test cases
#
# Hidden mechanisms (NOT in accessibility tree):
#   - aria-hidden="true" -> [hidden:aria-hidden]
#   - inert attribute -> [hidden:inert]
#   - display:none -> [hidden:display-none]
#   - visibility:hidden -> [hidden:visibility-hidden]
#   - visibility:collapse -> [hidden:visibility-collapse]
#   - HTML5 hidden attribute -> [hidden:display-none]
#   - Ancestor hidden -> [hidden:ancestor]
#
# Visually-hidden mechanisms (IN accessibility tree):
#   - opacity:0 -> [visually-hidden:opacity]
#   - sr-only clip pattern -> [visually-hidden:clipped]
#   - offscreen positioning -> [visually-hidden:offscreen]
#
# Key Phase 2 changes:
#   - Granular markers instead of [hidden:css]
#   - opacity:0 now IN accessibility tree (was excluded)
#   - sr-only patterns now detected with [visually-hidden:clipped]
#   - Ancestor propagation via [hidden:ancestor]
#   - Single marker per element (first match wins)
